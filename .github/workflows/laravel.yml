name: Laravel Tests

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_sqlite

      - name: Copy .env
        run: cp .env.example .env

      - name: Install Dependencies
        run: composer install --ignore-platform-reqs --no-interaction --prefer-dist

      - name: Generate key
        run: php artisan key:generate

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install ChromeDriver
        run: php artisan dusk:chrome-driver --detect

      - name: Create SQLite DBs
        run: |
          mkdir -p database
          touch database/testing.sqlite
          touch database/dusk.sqlite

      - name: Set Permissions
        run: chmod -R 777 storage bootstrap/cache database

      - name: Run migrations for PHPUnit
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/testing.sqlite
        run: php artisan migrate --force

      - name: Start Laravel Server
        run: php artisan serve --no-reload --host=127.0.0.1 --port=8000 &
        env:
          APP_URL: http://127.0.0.1:8000

      - name: Start ChromeDriver (Headless CI)
        run: |
          chmod +x ./vendor/laravel/dusk/bin/chromedriver-linux
          ./vendor/laravel/dusk/bin/chromedriver-linux --port=9515 --no-sandbox --disable-gpu --disable-dev-shm-usage &

      - name: Run PHPStan Strict Level 5
        run: |
          echo "ðŸš€ Running PHPStan strict analysis (Level 5)..."
          vendor/bin/phpstan analyse --ansi --memory-limit=2G
