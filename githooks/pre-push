#!/bin/sh
echo "==== Optimized Laravel Pre-Push Pipeline (PHPStan L5) ===="

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# -------- Detect base for diff --------
git show-ref --verify --quiet refs/remotes/origin/$BRANCH
if [ $? -eq 0 ]; then
  BASE="origin/$BRANCH...HEAD"
else
  echo "Remote branch not found — using last commit as base"
  BASE="HEAD~1"
fi

# -------- Changed PHP files only (skip vendor/config/storage) --------
CHANGED=$(git diff --name-only --diff-filter=ACMRT $BASE \
| grep "\.php$" \
| grep -Ev "^(vendor/|config/|storage/framework/)")

if [ -z "$CHANGED" ]; then
  echo "No PHP changes — skipping static checks"
else
  echo "▶ Changed PHP files:"
  echo "$CHANGED"

  echo "--------------------------------------------------"
  echo "▶ PHPStan level 5 (changed files)"
  vendor/bin/phpstan analyse $CHANGED \
    --level=5 \
    --memory-limit=512M \
    --error-format=table
  if [ $? -ne 0 ]; then
    echo "❌ PHPStan level 5 failed"
    exit 1
  fi

  echo "--------------------------------------------------"
  echo "▶ Pint auto-fix"
  vendor/bin/pint $CHANGED
  git add $CHANGED

  echo "▶ Pint verify"
  vendor/bin/pint --test $CHANGED
  if [ $? -ne 0 ]; then
    echo "❌ Pint still failing"
    exit 1
  fi
fi

echo "--------------------------------------------------"
echo "▶ Checking pending migrations"
PENDING_MIGRATIONS=$(php artisan migrate:status --quiet | grep "No")
if [ -n "$PENDING_MIGRATIONS" ]; then
  echo "❌ Pending migrations detected — run php artisan migrate"
  exit 1
fi

echo "--------------------------------------------------"
echo "▶ Running PHPUnit (Unit & Feature tests only)"
TEST_CHANGED=$(git diff --name-only --diff-filter=ACMRT $BASE \
| grep "^tests/.*Test\.php$")

if [ -n "$TEST_CHANGED" ]; then
  echo "▶ Running only changed tests"
  vendor/bin/phpunit --stop-on-failure $TEST_CHANGED --colors=always
else
  echo "▶ Running all Unit + Feature tests (excluding Dusk)"
  vendor/bin/phpunit --stop-on-failure --exclude-group=dusk --colors=always
fi

if [ $? -ne 0 ]; then
  echo "❌ Tests failed"
  exit 1
fi

echo "--------------------------------------------------"
echo "✅ All checks passed — push allowed"
exit 0
